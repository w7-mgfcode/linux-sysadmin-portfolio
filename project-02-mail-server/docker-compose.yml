services:
  # SSL Certificate Init Container (runs once)
  cert-init:
    build: ./init
    container_name: mail-cert-init
    restart: "no"
    volumes:
      - mail-ssl-certs:/etc/mail/certs
    environment:
      - MAIL_HOSTNAME=${MAIL_HOSTNAME:-mail.example.com}
      - SSL_DAYS_VALID=${SSL_DAYS_VALID:-3650}

  # MySQL Database (virtual users)
  mysql:
    image: mysql:8.0
    container_name: mail-mysql
    restart: unless-stopped
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD:-mail_root_changeme}
      - MYSQL_DATABASE=${MYSQL_DATABASE:-mailserver}
      - MYSQL_USER=${MYSQL_USER:-mailuser}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD:-mail_secure_changeme}
      - TZ=${TZ:-UTC}
    volumes:
      - mail-mysql-data:/var/lib/mysql
      - ./mysql/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - backend
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # Postfix (SMTP server)
  postfix:
    build: ./postfix
    container_name: mail-postfix
    restart: unless-stopped
    hostname: ${MAIL_HOSTNAME:-mail.example.com}
    depends_on:
      cert-init:
        condition: service_completed_successfully
      mysql:
        condition: service_healthy
    ports:
      - "${SMTP_PORT:-25}:25"
      - "${SUBMISSION_PORT:-587}:587"
      - "${SMTPS_PORT:-465}:465"
    volumes:
      - mail-ssl-certs:/etc/mail/certs:ro
      - mail-mailboxes:/var/mail/vhosts
      - mail-queue:/var/spool/postfix
      - mail-logs:/var/log/mail
      - ./scripts:/scripts:ro
    environment:
      - MAIL_DOMAIN=${MAIL_DOMAIN:-example.com}
      - MAIL_HOSTNAME=${MAIL_HOSTNAME:-mail.example.com}
      - MYSQL_HOST=mysql
      - MYSQL_DATABASE=${MYSQL_DATABASE:-mailserver}
      - MYSQL_USER=${MYSQL_USER:-mailuser}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD:-mail_secure_changeme}
    networks:
      - frontend
      - backend
    healthcheck:
      test: ["CMD", "postfix", "status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Dovecot (IMAP/POP3 server)
  dovecot:
    build: ./dovecot
    container_name: mail-dovecot
    restart: unless-stopped
    hostname: ${MAIL_HOSTNAME:-mail.example.com}
    depends_on:
      cert-init:
        condition: service_completed_successfully
      mysql:
        condition: service_healthy
      postfix:
        condition: service_healthy
    ports:
      - "${IMAP_PORT:-143}:143"
      - "${IMAPS_PORT:-993}:993"
      - "${POP3_PORT:-110}:110"
      - "${POP3S_PORT:-995}:995"
    volumes:
      - mail-ssl-certs:/etc/mail/certs:ro
      - mail-mailboxes:/var/mail/vhosts
      - mail-logs:/var/log/mail
      - ./scripts:/scripts:ro
    environment:
      - MAIL_DOMAIN=${MAIL_DOMAIN:-example.com}
      - MYSQL_HOST=mysql
      - MYSQL_DATABASE=${MYSQL_DATABASE:-mailserver}
      - MYSQL_USER=${MYSQL_USER:-mailuser}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD:-mail_secure_changeme}
    networks:
      - frontend
      - backend
    healthcheck:
      test: ["CMD", "doveconf", "-n"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # SpamAssassin (spam filter)
  spamassassin:
    build: ./spamassassin
    container_name: mail-spamassassin
    restart: unless-stopped
    depends_on:
      postfix:
        condition: service_healthy
    volumes:
      - mail-spam-data:/var/lib/spamassassin
      - mail-logs:/var/log/mail
    networks:
      - backend
    healthcheck:
      test: ["CMD", "spamc", "-K"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Roundcube (webmail)
  roundcube:
    image: roundcube/roundcubemail:latest
    container_name: mail-roundcube
    restart: unless-stopped
    depends_on:
      mysql:
        condition: service_healthy
      dovecot:
        condition: service_healthy
      postfix:
        condition: service_healthy
    ports:
      - "${WEBMAIL_PORT:-80}:80"
    environment:
      - ROUNDCUBEMAIL_DEFAULT_HOST=ssl://dovecot
      - ROUNDCUBEMAIL_DEFAULT_PORT=993
      - ROUNDCUBEMAIL_SMTP_SERVER=tls://postfix
      - ROUNDCUBEMAIL_SMTP_PORT=587
      - ROUNDCUBEMAIL_DB_TYPE=mysql
      - ROUNDCUBEMAIL_DB_HOST=mysql
      - ROUNDCUBEMAIL_DB_NAME=roundcube
      - ROUNDCUBEMAIL_DB_USER=${MYSQL_USER:-mailuser}
      - ROUNDCUBEMAIL_DB_PASSWORD=${MYSQL_PASSWORD:-mail_secure_changeme}
    networks:
      - frontend
      - backend
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # Dashboard (monitoring interface)
  dashboard:
    build: ./dashboard
    container_name: mail-dashboard
    restart: unless-stopped
    depends_on:
      mysql:
        condition: service_healthy
      postfix:
        condition: service_healthy
      dovecot:
        condition: service_healthy
      spamassassin:
        condition: service_healthy
    ports:
      - "${DASHBOARD_PORT:-8080}:80"
    volumes:
      - mail-logs:/var/log/mail:ro
      - mail-reports:/var/reports:ro
      - ./scripts:/scripts:ro
    environment:
      - MYSQL_HOST=mysql
      - MYSQL_DATABASE=${MYSQL_DATABASE:-mailserver}
      - MYSQL_USER=${MYSQL_USER:-mailuser}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD:-mail_secure_changeme}
      - REPORT_DIR=/var/reports
    networks:
      - frontend
      - backend
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

networks:
  frontend:
    driver: bridge
    name: mail-frontend
  backend:
    driver: bridge
    name: mail-backend
    internal: true

volumes:
  mail-mysql-data:
    name: mail-mysql-data
  mail-ssl-certs:
    name: mail-ssl-certs
  mail-mailboxes:
    name: mail-mailboxes
  mail-queue:
    name: mail-queue
  mail-logs:
    name: mail-logs
  mail-reports:
    name: mail-reports
  mail-backups:
    name: mail-backups
  mail-spam-data:
    name: mail-spam-data
