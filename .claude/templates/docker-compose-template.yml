# Docker Compose Template for Linux Sysadmin Portfolio Projects
# Version: 3.8+
# Replace [placeholders] with actual values

version: '3.8'

# ==============================================================================
# Services
# ==============================================================================
services:

  # ----------------------------------------------------------------------------
  # Main Application Service
  # ----------------------------------------------------------------------------
  app:
    build:
      context: ./app
      dockerfile: Dockerfile
      args:
        - APP_VERSION=${APP_VERSION:-latest}
    image: ${PROJECT_NAME:-project}-app:${APP_VERSION:-latest}
    container_name: ${PROJECT_NAME:-project}-app
    hostname: app
    restart: unless-stopped

    # Ports
    ports:
      - "${APP_PORT:-8080}:8080"

    # Environment
    environment:
      - TZ=${TZ:-UTC}
      - APP_ENV=${APP_ENV:-production}
      - LOG_LEVEL=${LOG_LEVEL:-info}

    # Volumes
    volumes:
      - app_data:/app/data
      - ./scripts:/scripts:ro
      - ./logs:/var/log/app

    # Networking
    networks:
      - frontend
      - backend

    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M

    # Dependencies
    depends_on:
      db:
        condition: service_healthy

    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ----------------------------------------------------------------------------
  # Web Server / Reverse Proxy (Nginx)
  # ----------------------------------------------------------------------------
  nginx:
    image: nginx:1.25-alpine
    container_name: ${PROJECT_NAME:-project}-nginx
    hostname: nginx
    restart: unless-stopped

    ports:
      - "${HTTP_PORT:-80}:80"
      - "${HTTPS_PORT:-443}:443"

    environment:
      - TZ=${TZ:-UTC}

    volumes:
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - nginx_logs:/var/log/nginx

    networks:
      - frontend

    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3

    depends_on:
      - app

  # ----------------------------------------------------------------------------
  # Database (MySQL)
  # ----------------------------------------------------------------------------
  db:
    image: mysql:8.0
    container_name: ${PROJECT_NAME:-project}-db
    hostname: db
    restart: unless-stopped

    # Don't expose to host in production
    # ports:
    #   - "${DB_PORT:-3306}:3306"

    environment:
      - TZ=${TZ:-UTC}
      - MYSQL_ROOT_PASSWORD=${DB_ROOT_PASSWORD:?DB_ROOT_PASSWORD is required}
      - MYSQL_DATABASE=${DB_NAME:-appdb}
      - MYSQL_USER=${DB_USER:-appuser}
      - MYSQL_PASSWORD=${DB_PASSWORD:?DB_PASSWORD is required}

    volumes:
      - db_data:/var/lib/mysql
      - ./mysql/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
      - ./mysql/conf.d:/etc/mysql/conf.d:ro

    networks:
      - backend

    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${DB_ROOT_PASSWORD}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M

  # ----------------------------------------------------------------------------
  # Database Admin UI (Adminer) - Development only
  # ----------------------------------------------------------------------------
  adminer:
    image: adminer:latest
    container_name: ${PROJECT_NAME:-project}-adminer
    restart: unless-stopped
    profiles:
      - dev  # Only starts with: docker compose --profile dev up

    ports:
      - "${ADMINER_PORT:-8081}:8080"

    environment:
      - ADMINER_DEFAULT_SERVER=db

    networks:
      - backend

    depends_on:
      - db

  # ----------------------------------------------------------------------------
  # Cache (Redis) - Optional
  # ----------------------------------------------------------------------------
  # redis:
  #   image: redis:7-alpine
  #   container_name: ${PROJECT_NAME:-project}-redis
  #   hostname: redis
  #   restart: unless-stopped
  #
  #   volumes:
  #     - redis_data:/data
  #
  #   networks:
  #     - backend
  #
  #   healthcheck:
  #     test: ["CMD", "redis-cli", "ping"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5

# ==============================================================================
# Networks
# ==============================================================================
networks:
  frontend:
    driver: bridge
    name: ${PROJECT_NAME:-project}-frontend

  backend:
    driver: bridge
    name: ${PROJECT_NAME:-project}-backend
    internal: true  # No external access

# ==============================================================================
# Volumes
# ==============================================================================
volumes:
  app_data:
    name: ${PROJECT_NAME:-project}-app-data

  db_data:
    name: ${PROJECT_NAME:-project}-db-data

  nginx_logs:
    name: ${PROJECT_NAME:-project}-nginx-logs

  # redis_data:
  #   name: ${PROJECT_NAME:-project}-redis-data

# ==============================================================================
# Usage Examples
# ==============================================================================
#
# Start all services:
#   docker compose up -d
#
# Start with dev tools (adminer):
#   docker compose --profile dev up -d
#
# View logs:
#   docker compose logs -f
#   docker compose logs -f app
#
# Execute commands in container:
#   docker compose exec app /scripts/backup.sh
#
# Restart a service:
#   docker compose restart app
#
# Rebuild and restart:
#   docker compose up -d --build
#
# Stop all services:
#   docker compose down
#
# Stop and remove volumes (WARNING: data loss):
#   docker compose down -v
#
